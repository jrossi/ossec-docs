<!DOCTYPE html>


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>When the unexpected happens: FAQ &mdash; OSSEC</title>
    
    <link rel="stylesheet" href="../../_static/basic.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/bootstrap-3.2.0/css/bootstrap.min.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/bootstrap-3.2.0/css/bootstrap-theme.min.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/parallax.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '2.8.2',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="../../_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="../../_static/bootstrap-3.2.0/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../../_static/bootstrap-sphinx.js"></script>
    <link rel="author" title="About these documents" href="../../about.html" />
    <link rel="top" title="OSSEC" href="../../index.html" />
  
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">

  
  
  <link href="http://netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.min.css" rel="stylesheet">
  
  <style type="text/css">
    ul.ablog-archive {list-style: none; overflow: auto; margin-left: 0px}
    ul.ablog-archive li {float: left; margin-right: 5px; font-size: 80%}
  </style>

  </head>
  <body role="document">

  <div id="navbar" class="navbar navbar-inverse navbar-default ">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../../index.html"><img src="../../_static/ossec_logo_bare_small.png">
          OSSEC</a>
        <span class="navbar-text navbar-version pull-left"><b></b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
                <li><a href="../../about.html">About <i class="fa fa-info-circle"></i></a></li>
                <li><a href="../../blog.html">Blog <i class="fa fa-archive"></i></a></li>
                <li><a href="../">Documentaton <i class="fa fa-book"></i></a></li>
                <li><a href="../../downloads.html">Downloads <i class="fa fa-download"></i></a></li>
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../../index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"></ul>
</li>
              
            
            
              
                
              
            
            
            
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="col-md-12">
      
  <div class="section" id="when-the-unexpected-happens-faq">
<span id="faq-unexpected"></span><h1>When the unexpected happens: FAQ<a class="headerlink" href="#when-the-unexpected-happens-faq" title="Permalink to this headline">¶</a></h1>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><a class="reference internal" href="#how-do-i-troubleshoot-ossec" id="id1">How do I troubleshoot ossec?</a></li>
<li><a class="reference internal" href="#how-to-debug-ossec" id="id2">How to debug ossec?</a></li>
<li><a class="reference internal" href="#the-communication-between-my-agent-and-the-server-is-not-working-what-to-do" id="id3">The communication between my agent and the server is not working. What to do?</a></li>
<li><a class="reference internal" href="#what-does-1403-incorrectly-formated-message-means" id="id4">What does &#8220;1403 - Incorrectly formated message&#8221; means?</a></li>
<li><a class="reference internal" href="#what-does-1210-queue-not-accessible-mean" id="id5">What does &#8220;1210 - Queue not accessible?&#8221; mean?</a><ul>
<li><a class="reference internal" href="#check-queue-ossec-queue" id="id6">Check queue/ossec/queue</a></li>
<li><a class="reference internal" href="#check-queue-alerts-ar" id="id7">Check queue/alerts/ar</a></li>
</ul>
</li>
<li><a class="reference internal" href="#remote-commands-are-not-accepted-from-the-manager-ignoring-it-on-the-agent-conf" id="id8">Remote commands are not accepted from the manager. Ignoring it on the agent.conf</a></li>
<li><a class="reference internal" href="#errors-when-dealing-with-multiple-agents" id="id9">Errors when dealing with multiple agents</a></li>
<li><a class="reference internal" href="#fixing-duplicate-errors" id="id10">Fixing Duplicate Errors</a></li>
<li><a class="reference internal" href="#agent-won-t-connect-to-the-manager-or-the-agent-always-shows-never-connected" id="id11">Agent won&#8217;t connect to the manager or the agent always shows never connected</a></li>
<li><a class="reference internal" href="#i-am-seeing-high-cpu-utilization-on-a-windows-agent" id="id12">I am seeing high CPU utilization on a Windows agent</a></li>
<li><a class="reference internal" href="#my-etc-hosts-deny-file-is-blank-after-install-2-8-1" id="id13">My /etc/hosts.deny file is blank after install 2.8.1!</a></li>
</ul>
</div>
<div class="section" id="how-do-i-troubleshoot-ossec">
<h2><a class="toc-backref" href="#id1">How do I troubleshoot ossec?</a><a class="headerlink" href="#how-do-i-troubleshoot-ossec" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><p>If you are having problems with ossec, the first thing to do is to look at
your logs.</p>
<ul class="simple">
<li>Unix/Linux: The logs will be at /var/ossec/logs/ossec.log</li>
<li>Windows: The logs are at  C:Program Filesossec-agentossec.log.</li>
</ul>
<p>If by looking at them, you can&#8217;t find out the error, we suggest you to send an
e-mail to one of our mailing lists with the following information:</p>
<ul>
<li><p class="first">OSSEC version number.</p>
<blockquote>
<div><p>Run the following to get the version installation.</p>
<div class="highlight-console"><div class="highlight"><pre><span class="gp">#</span> /var/ossec/bin/ossec-analysisd -V
</pre></div>
</div>
</div></blockquote>
</li>
<li><p class="first">Content of /etc/ossec-init.conf</p>
</li>
<li><p class="first">Content of /var/ossec/etc/ossec.conf or (or C:Program Filesossec-agentossec.log if Windows)</p>
</li>
<li><p class="first">Content of /var/ossec/logs/ossec.log</p>
</li>
<li><p class="first">Operating system name/version (uname -a if Unix)</p>
</li>
<li><p class="first">Any other relevant information.</p>
</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="how-to-debug-ossec">
<h2><a class="toc-backref" href="#id2">How to debug ossec?</a><a class="headerlink" href="#how-to-debug-ossec" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Only read this section if you tried to troubleshoot ossec already, but
didn&#8217;t have lucky solving your problem.  Most of the users will never need
to enable debugging, since it can significantly hurt performance.</p>
</div>
<p><strong>Debug Logging</strong></p>
<p>You can also enable debugging mode on ossec to extract more data about
what is going on. To do so, you will need to modify the file
/var/ossec/etc/internal_options.conf (or
C:\Program Files\ossec-agent\internal_options.conf on Windows) and change
the debug level from the default &#8220;0&#8221; to &#8220;1&#8221; or &#8220;2&#8221;.</p>
<p>For example, if you wish to debug your windows agent, just change the option
windows.debug from 0 to 2. Bellow is the list of all the debug options:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="gp">#</span> Debug options.
<span class="gp">#</span> Debug <span class="m">0</span> -&gt; no debug
<span class="gp">#</span> Debug <span class="m">1</span> -&gt; first level of debug
<span class="gp">#</span> Debug <span class="m">2</span> -&gt; full debugging

<span class="gp">#</span> Windows debug <span class="o">(</span>used by the windows agent<span class="o">)</span>
<span class="go">windows.debug=0</span>

<span class="gp">#</span> Syscheck <span class="o">(</span><span class="nb">local</span>, server and unix agent<span class="o">)</span>
<span class="go">syscheck.debug=0</span>

<span class="gp">#</span> Remoted <span class="o">(</span>server debug<span class="o">)</span>
<span class="go">remoted.debug=0</span>

<span class="gp">#</span> Analysisd <span class="o">(</span>server or <span class="nb">local</span><span class="o">)</span>
<span class="go">analysisd.debug=0</span>

<span class="gp">#</span> Log collector <span class="o">(</span>server, <span class="nb">local </span>or unix agent<span class="o">)</span>
<span class="go">logcollector.debug=0</span>

<span class="gp">#</span> Unix agentd
<span class="go">agent.debug=0</span>
</pre></div>
</div>
<p>If this is on an OSSEC server you can enable debug by running:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="gp">#</span> /var/ossec/bin/ossec-control <span class="nb">enable </span>debug
</pre></div>
</div>
<p>Enable debug mode and restart the OSSEC processes to view more verbose logs.</p>
<p><strong>Getting more log data</strong></p>
<p>If you are up to editing the source and recompiling, you can use the verbose()
function to add entries to the log. This has been helpful on at least one occasion
to help pinpoint where a problem was occurring. Something along these lines should
work (at least in 1.3):</p>
<div class="highlight-c"><div class="highlight"><pre><span class="n">verbose</span><span class="p">(</span><span class="s">&quot;MyName: inside the_file.c the_function() %s ..&quot;</span><span class="p">,</span> <span class="n">the_string</span><span class="p">);</span>
</pre></div>
</div>
<ul class="simple">
<li>If you tag all your extra logs with something, MyName, in this example, they
stand out better.</li>
<li>If you need to get information from several source files, including the file
name the_file.c, in this example is helpful.</li>
<li>You will almost surely want information from more than one fuction, including
the name, the_fuction() will show which function sent the log.</li>
<li>Finally, you can include a variable string with the printf format specifier %s
in the log entry and the_string is the name of the string variable to send to the log.</li>
</ul>
<p>With some calls to verbose, recompile and replace the stock binary with your edited
one. Restart ossec and tail the log.</p>
</div></blockquote>
</div>
<div class="section" id="the-communication-between-my-agent-and-the-server-is-not-working-what-to-do">
<span id="faq-unexpected-comm"></span><h2><a class="toc-backref" href="#id3">The communication between my agent and the server is not working. What to do?</a><a class="headerlink" href="#the-communication-between-my-agent-and-the-server-is-not-working-what-to-do" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><p>There are multiple reasons for it to happen. First, you should look at
your agent and server logs to see what they say.  If you don&#8217;t know where they
are, go to our Troubleshooting page for more information.</p>
<p>In addition to that, follow the step by step at the end, if you need to add/re-add
the authentication keys.</p>
<p><strong>There is a firewall between the agent and the server.</strong></p>
<p>If you have the following message on the agent log:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="go">2007/04/19 12:42:54 ossec-agentd(4101): Waiting for server reply (not started).</span>
<span class="go">2007/04/19 12:43:10 ossec-agentd(4101): Waiting for server reply (not started).</span>
<span class="go">2007/04/19 12:43:41 ossec-agentd(4101): Waiting for server reply (not started).</span>
<span class="go">2007/04/19 12:44:27 ossec-agentd(4101): Waiting for server reply (not started).</span>
</pre></div>
</div>
<p>And nothing on the server log, you probably have a firewall between the two
devices. Make sure to open port 1514 UDP between them (keeping state &#8211;the
agent connects to the server and expects a reply back).</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The way the agent/server communication works is that the agent starts a
connection to the server using any random high port. So, the only port that
OSSEC opens is in the server side (port 1514 UDP). It works similar to DNS,
where the DNS client connects to UDP port 53 and expects a reply back.</p>
</div>
<p><strong>Wrong authentication keys configured (you imported a key from a different agent).</strong></p>
<p>If that&#8217;s the case, you would be getting logs similar to the above on the agent
and the following on the server (see also Errors:1403):</p>
<div class="highlight-console"><div class="highlight"><pre><span class="go">2007/05/23 09:27:35 ossec-remoted(1403): Incorrectly formated message from &#39;xxx.xxx.xxx.xxx&#39;.</span>
<span class="go">2007/05/23 09:27:35 ossec-remoted(1403): Incorrectly formated message from &#39;xxx.xxx.xxx.xxx&#39;.&#39;&#39;</span>
</pre></div>
</div>
<p><strong>The IP address you configured the agent is different from what the server is seeing.</strong></p>
<p>Same as above (see also see Errors:1403).</p>
<p><strong>Step by Step &#8211; adding the authentication keys</strong></p>
<p>For most of the errors (except the firewall issue), removing and re-adding the authentication keys
fix the problem. Do the following if you are having issues:</p>
<ol class="arabic">
<li><p class="first">&#8216;Stop the server and the agent.&#8217;</p>
<blockquote>
<div><ul class="simple">
<li>Make sure they are really stopped (ps on Unix or sc query ossecsvc on Windows)</li>
</ul>
</div></blockquote>
</li>
<li><p class="first">Run the manage-agents tool on the server and remove the agent.</p>
</li>
<li><p class="first">Still on the server, add the agent using manage-agents. Make sure the IP is correct.</p>
</li>
<li><p class="first">Start the server.</p>
</li>
<li><p class="first">Run manage-agents on the agent and import the newly generated key.</p>
</li>
<li><p class="first">Start the agent.</p>
</li>
</ol>
<p>If after that, it still doesn&#8217;t work, contact our mailing list for help.</p>
</div></blockquote>
</div>
<div class="section" id="what-does-1403-incorrectly-formated-message-means">
<h2><a class="toc-backref" href="#id4">What does &#8220;1403 - Incorrectly formated message&#8221; means?</a><a class="headerlink" href="#what-does-1403-incorrectly-formated-message-means" title="Permalink to this headline">¶</a></h2>
<p>It means that the server (or agent) wasn&#8217;t able to decrypt the message from the
other side of the connection.  See <a class="reference internal" href="#the-communication-between-my-agent-and-the-server-is-not-working-what-to-do">The communication between my agent and the server is not working. What to do?</a></p>
<p>The main reasons for this to happen are:</p>
<ul class="simple">
<li>Wrong authentication keys configured (you imported a key from a different agent).</li>
<li>The IP address you configured the agent is different from what the server is seeing.</li>
</ul>
<p>How to fix it:</p>
<ul class="simple">
<li>Check if you imported the right authentication keys into the agent.</li>
<li>Check if the IP address is correctly.</li>
<li>You can also try to remove the agent (using manage_agents), add it back again
and re-import the keys into the agent. Make sure to restart the server (first)
and then the agent after that.</li>
</ul>
</div>
<div class="section" id="what-does-1210-queue-not-accessible-mean">
<h2><a class="toc-backref" href="#id5">What does &#8220;1210 - Queue not accessible?&#8221; mean?</a><a class="headerlink" href="#what-does-1210-queue-not-accessible-mean" title="Permalink to this headline">¶</a></h2>
<div class="section" id="check-queue-ossec-queue">
<h3><a class="toc-backref" href="#id6">Check queue/ossec/queue</a><a class="headerlink" href="#check-queue-ossec-queue" title="Permalink to this headline">¶</a></h3>
<p>If you have logs similar to the following in <code class="docutils literal"><span class="pre">/var/ossec/queue/ossec/queue</span></code>:</p>
<div class="highlight-python"><div class="highlight"><pre>2008/04/29 15:40:39 ossec-syscheckd(1210): ERROR: Queue &#39;/var/ossec/queue/ossec/queue&#39; not accessible: &#39;Connection refused&#39;.
2008/04/29 15:40:39 ossec-rootcheck(1210): ERROR: Queue &#39;/var/ossec/queue/ossec/queue&#39; not accessible: &#39;Connection refused&#39;.
2008/04/29 15:40:45 ossec-logcollector(1210): ERROR: Queue &#39;/var/ossec/queue/ossec/queue&#39; not accessible: &#39;Connection refused&#39;.
2008/04/29 15:40:45 ossec-logcollector(1211): ERROR: Unable to access queue: &#39;/var/ossec/queue/ossec/queue&#39;. Giving up..
2008/04/29 15:41:00 ossec-syscheckd(1210): ERROR: Queue &#39;/var/ossec/queue/ossec/queue&#39; not accessible: &#39;Connection refused&#39;.
2008/04/29 15:41:00 ossec-rootcheck(1211): ERROR: Unable to access queue: &#39;/var/ossec/queue/ossec/queue&#39;. Giving up..
</pre></div>
</div>
<p>It means that <a class="reference internal" href="../programs/ossec-analysisd.html#ossec-analysisd"><span>ossec-analysisd</span></a> is not running for some reason.</p>
<p><strong>The main reasons for this to happen are:</strong></p>
<ul class="simple">
<li><a class="reference internal" href="../programs/ossec-analysisd.html#ossec-analysisd"><span>ossec-analysisd</span></a> didn&#8217;t start properly. Look at the logs for any error from it.</li>
<li><a class="reference internal" href="../programs/ossec-analysisd.html#ossec-analysisd"><span>ossec-analysisd</span></a> didn&#8217;t start at all. There is a bug in the init scripts that
during system reboot, it may not start if the PID is already in use (we are working
to fix it).</li>
<li><a class="reference internal" href="../programs/ossec-analysisd.html#ossec-analysisd"><span>ossec-analysisd</span></a> cannot access <code class="docutils literal"><span class="pre">/queue/fts/fts-queue</span></code>. Look for the error message <code class="docutils literal"><span class="pre">ossec-analysisd(1103):</span> <span class="pre">ERROR:</span> <span class="pre">Unable</span> <span class="pre">to</span> <span class="pre">open</span> <span class="pre">file</span> <span class="pre">'/queue/fts/fts-queue'.</span></code> This can be fixed by ensuring that the ossec user owns <code class="docutils literal"><span class="pre">/var/ossec/queue/fts/fts-queue</span></code>.</li>
</ul>
<p><strong>How to fix it:</strong></p>
<p>Stop OSSEC and start it back again:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="gp">#</span> /var/ossec/bin/ossec-control stop
<span class="go">(you can also check at /var/ossec/var/run that there is not PID file in there)</span>
<span class="gp">#</span> /var/ossec/bin/ossec-control start
</pre></div>
</div>
<p>If there is any configuration error, fix it.</p>
</div>
<div class="section" id="check-queue-alerts-ar">
<h3><a class="toc-backref" href="#id7">Check queue/alerts/ar</a><a class="headerlink" href="#check-queue-alerts-ar" title="Permalink to this headline">¶</a></h3>
<p>If you have logs similar to the following in <code class="docutils literal"><span class="pre">/var/ossec/queue/alerts/ar</span></code>:</p>
<div class="highlight-python"><div class="highlight"><pre>2009/02/17 12:03:04 ossec-analysisd(1210): ERROR: Queue &#39;/queue/alerts/ar&#39; not accessible: &#39;Connection refused&#39;.
2009/02/17 12:03:04 ossec-analysisd(1301): ERROR: Unable to connect to active response queue.
</pre></div>
</div>
<p>It means that there is nothing listening on the other end of the socket the
<a class="reference internal" href="../programs/ossec-analysisd.html#ossec-analysisd"><span>ossec-analysisd</span></a> deamon would want to write to. This can happen in an ossec
server installation. The deamon that should be listening on this socket is
<a class="reference internal" href="../programs/ossec-remoted.html#ossec-remoted"><span>ossec-remoted</span></a>.</p>
<p><strong>How to fix it:</strong></p>
<p>Add an OSSEC client (agent) with the <a class="reference internal" href="../programs/manage_agents.html#manage-agents"><span>manage_agents</span></a> utility on both agent
and server. Then restart OSSEC. <a class="reference internal" href="../programs/ossec-remoted.html#ossec-remoted"><span>ossec-remoted</span></a> should now be listening on
the socket.</p>
</div>
</div>
<div class="section" id="remote-commands-are-not-accepted-from-the-manager-ignoring-it-on-the-agent-conf">
<h2><a class="toc-backref" href="#id8">Remote commands are not accepted from the manager. Ignoring it on the agent.conf</a><a class="headerlink" href="#remote-commands-are-not-accepted-from-the-manager-ignoring-it-on-the-agent-conf" title="Permalink to this headline">¶</a></h2>
<p>This error message is caused by <code class="docutils literal"><span class="pre">command</span></code> or <code class="docutils literal"><span class="pre">full_command</span></code> log types in the agent.conf.
Originally OSSEC supported running commands from the agent.conf by default. Thie was later changed as a security
precaution due to the commands being run as root. When a command is encountered on an agent in the agent.conf
this error will be produced and the agent may not fully start. This error may also accompany the above error
message:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="go">ERROR: Configuration error at &#39;/var/ossec-agent/etc/shared/agent.conf&#39;. Exiting.</span>
</pre></div>
</div>
</div>
<div class="section" id="errors-when-dealing-with-multiple-agents">
<h2><a class="toc-backref" href="#id9">Errors when dealing with multiple agents</a><a class="headerlink" href="#errors-when-dealing-with-multiple-agents" title="Permalink to this headline">¶</a></h2>
<p>When you have hundreds (or even thousands) of agents, OSSEC may not work
properly by default. There are a few changes that you will need to do:</p>
<p><strong>Increase maximum number of allowed agents</strong></p>
<p>To increase the number of agents, before you install (or update OSSEC), just do:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="gp">#</span><span class="nb">cd </span>src<span class="p">;</span> make setmaxagents <span class="o">(</span>it will ask how many <span class="k">do</span> you want.. <span class="o">)</span>

<span class="go">Specify maximum number of agents: 2048 (to increase to 2048)</span>
<span class="go">Maximum number of agents set to 20.</span>

<span class="gp">#</span><span class="nb">cd</span> ..<span class="p">;</span> ./install.sh
</pre></div>
</div>
<p><strong>Increase your system&#8217;s limits</strong></p>
<p>Most systems have limits regarding the maximum number of files you can have.
A few commands you should try are (to increase to 2048):</p>
<div class="highlight-console"><div class="highlight"><pre><span class="gp">#</span> <span class="nb">ulimit</span> -n 2048
<span class="gp">#</span> sysctl -w kern.maxfiles<span class="o">=</span>2048
</pre></div>
</div>
</div>
<div class="section" id="fixing-duplicate-errors">
<h2><a class="toc-backref" href="#id10">Fixing Duplicate Errors</a><a class="headerlink" href="#fixing-duplicate-errors" title="Permalink to this headline">¶</a></h2>
<p>Ossec agents and server keep a counter of each message sent and received in files in .../ossec/queue/rids.
This is a technique to prevent replay attacks. If the counters between agent and server don&#8217;t match you&#8217;ll see errors like this in the agents ossec.log file:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="go">2007/10/24 11:19:21 ossec-agentd: Duplicate error:  global: 12, local: 3456, saved global: 78, saved local: 91011</span>
<span class="go">2007/10/24 11:19:21 ossec-agentd(&lt;pid&gt;): Duplicated counter for &#39;&lt;host name&gt;&#39;.</span>
<span class="go">2007/10/24 11:19:21 ossec-agentd(&lt;pid&gt;): Problem receiving message from www.xxx.yyy.zzz.</span>
</pre></div>
</div>
<p>This normally happens when you restore the ossec files from a backup or you reinstall server or agents without performing an upgrade, this can also be caused by duplicate agent ID&#8217;s.
The fix for this problem is:</p>
<ol class="arabic simple">
<li>On every agent:</li>
</ol>
<blockquote>
<div><ol class="arabic simple">
<li>stop ossec</li>
<li>go to: .../ossec/queue/rids (or ossec-agent/rids on Windows) and remove every file in there.</li>
</ol>
</div></blockquote>
<ol class="arabic simple" start="2">
<li>Go to the server:</li>
</ol>
<blockquote>
<div><ol class="arabic simple">
<li>Stop ossec</li>
<li>Remove the rids file with the same name as the agent id that is reporting errors.</li>
</ol>
</div></blockquote>
<ol class="arabic simple" start="3">
<li>Restart the server</li>
<li>Restart the agents.</li>
</ol>
<dl class="docutils">
<dt>To avoid this problem from ever happening again, make sure to:</dt>
<dd><ul class="first last simple">
<li>Always use the update option (when updating). Do not remove and reinstall the ossec server, unless you plan to do the same for all agents.</li>
<li>Do not re-use the same agent key between multiple agents or the same agent key after you remove/re-install an agent. If you use the &#8220;update&#8221; options everything should just work.</li>
</ul>
</dd>
</dl>
</div>
<div class="section" id="agent-won-t-connect-to-the-manager-or-the-agent-always-shows-never-connected">
<h2><a class="toc-backref" href="#id11">Agent won&#8217;t connect to the manager or the agent always shows never connected</a><a class="headerlink" href="#agent-won-t-connect-to-the-manager-or-the-agent-always-shows-never-connected" title="Permalink to this headline">¶</a></h2>
<p>The following log messages may appear in the <code class="docutils literal"><span class="pre">ossec.log</span></code> file on an agent when it is having issues connecting to a manager:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="go">2011/11/13 18:05:13 ossec-agent: WARN: Process locked. Waiting for permission...</span>
<span class="go">2011/11/13 18:05:24 ossec-agent(4101): WARN: Waiting for server reply (not started). Tried: &#39;10.10.134.241&#39;.</span>
<span class="go">2011/11/13 18:05:26 ossec-agent: INFO: Trying to connect to server (10.10.134.241:1514).</span>
<span class="go">2011/11/13 18:05:26 ossec-agent: INFO: Using IPv4 for: 10.10.134.241 .</span>
<span class="go">2011/11/13 18:05:47 ossec-agent(4101): WARN: Waiting for server reply (not started). Tried: &#39;10.10.134.241&#39;.</span>
</pre></div>
</div>
<p>If the agent&#8217;s packets are making it to the manager, the manager will also include error messages in its <code class="docutils literal"><span class="pre">ossec.log</span></code> related to that agent. Some possible issues:</p>
<ul class="simple">
<li>The agent may not be using the correct IP address. Some systems with multiple IP addresses may not choose the correct one to communicate with the OSSEC manager. Using <code class="docutils literal"><span class="pre">any</span></code> or a CIDR address (192.168.1.0/24) for the agent may be one solution, and adjusting the system&#8217;s route settings is another.</li>
<li>Every agent must be using a unique key. If 2 agents look like they&#8217;re coming from the same IP (possibly from a NAT gateway), then <code class="docutils literal"><span class="pre">any</span></code> or the CIDR address should be used to identify them on the manager.</li>
<li>There may be a firewall blocking the OSSEC traffic, udp 1514 should be allowed to and from the manager.</li>
<li>UAC may be blocking the OSSEC service from communicating with the manager on Windows 7.</li>
</ul>
</div>
<div class="section" id="i-am-seeing-high-cpu-utilization-on-a-windows-agent">
<h2><a class="toc-backref" href="#id12">I am seeing high CPU utilization on a Windows agent</a><a class="headerlink" href="#i-am-seeing-high-cpu-utilization-on-a-windows-agent" title="Permalink to this headline">¶</a></h2>
<p>Some OSSEC HIDS users who have deployed the Windows agent have experienced situations where the windows OSSEC agent causes high CPU utilization. In some cases, this may be due to syscheck having to do integrity checking on a large number of files and the frequency with which this is done. The high CPU utilization could also take place when the OSSEC agent has to analyze Windows Event logs with very large numbers of generated events.</p>
<p>A clue to what may be happening are alerts like these:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="go">OSSEC HIDS Notification.</span>
<span class="go">2006 Oct 24 03:18:07</span>

<span class="go">Received From: (ACME-5) 10.23.54.40-&gt;WinEvtLog</span>
<span class="go">Rule: 11 fired (level 8) -&gt; &quot;Excessive number of events (above normal).&quot;</span>
<span class="go">Portion of the log(s):</span>

<span class="go">The average number of logs between 3:00 and 4:00 is 268689. We reached 270690.</span>



<span class="go">--END OF NOTIFICATION</span>
</pre></div>
</div>
<p>The above alert indicates the condition where a large number of events are being generated in the Windows event logs. In Windows, setting the Windows audit policy to <a class="reference external" href="http://technet2.microsoft.com/WindowsServer/en/library/50fdb7bc-7dae-4dcd-8591-382aeff2ea791033.mspx?mfr=true">Audit Object Access</a> or <a class="reference external" href="http://technet2.microsoft.com/WindowsServer/en/library/50fdb7bc-7dae-4dcd-8591-382aeff2ea791033.mspx?mfr=true">Audit Process Tracking</a> can cause the generation of many event log entries. This gives the OSSEC agent much more work to do in log analysis, and thus causes the consumption of much more CPU cycles. To reduce the CPU utilization in this case, the solution is to disable auditing of object access and/or process tracking. Typically, these audit settings aren&#8217;t required except for debugging purposes, or situations in which you absolutely have to track everything.</p>
</div>
<div class="section" id="my-etc-hosts-deny-file-is-blank-after-install-2-8-1">
<h2><a class="toc-backref" href="#id13">My /etc/hosts.deny file is blank after install 2.8.1!</a><a class="headerlink" href="#my-etc-hosts-deny-file-is-blank-after-install-2-8-1" title="Permalink to this headline">¶</a></h2>
<p>There was a bug introduced to the host-deny.sh script that would empty the file. It has been fixed for 2.9.
Some variable declarations in the script have a space between the variable name, the <code class="docutils literal"><span class="pre">=</span></code>, and the value.
Removing these spaces allows the script to work as planned.
If you are using a system that is still using tcpwrappers, either use the current <a class="reference external" href="https://raw.githubusercontent.com/ossec/ossec-hids/master/active-response/host-deny.sh">host-deny.sh</a>, or remove the spaces from the script before installation.</p>
</div>
</div>

  <div class="section">
  
  
  </div>

    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2010-2015, OSSEC Project Team - OSSEC trademark and domain owned by Trend Micro, Inc. - Home page images courtesy of Pixbay.com.<br/>
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.3.1.<br/>
    </p>
  </div>
</footer>
  </body>
</html>